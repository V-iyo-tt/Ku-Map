<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  
  <meta name="referrer" content="origin">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Naver Map (Geocoding)</title>
  <style>
    html,body,#map{height:100%;margin:0;padding:0}
    .hud{position:fixed;left:8px;bottom:8px;background:#0008;color:#fff;padding:6px 10px;border-radius:8px;font:12px/1.3 system-ui; z-index: 1000;}
  </style>
  <script>
  (function(){
    const DEFAULT_CID = "pu0ce4kfq8"; // 클라이언트 ID

    const qs = new URLSearchParams(location.search);
    const cid = (qs.get('cid') || DEFAULT_CID).trim();
    
    // URL에서 'place' 파라미터 가져오기
    const place = (qs.get('place') || '').trim();
    
    let lat = parseFloat(qs.get('lat') || '37.58361');
    let lng = parseFloat(qs.get('lng') || '127.02528');
    const zoom = parseInt(qs.get('zoom') || '17', 10);

    let map;

    function ready(fn){
      if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', fn, {once:true});
      else fn();
    }

    function hud(msg){
      let h=document.querySelector('.hud');
      if(!h){ h=document.createElement('div'); h.className='hud'; document.body.appendChild(h); }
      h.textContent=msg;
    }

    // ★ [핵심 2] 주소 검색 모듈 로드 (&submodules=geocoder 필수)
    const s = document.createElement('script');
    s.src = 'https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=' + encodeURIComponent(cid) + '&submodules=geocoder';

    s.onload = () => ready(() => {
      // 1. 맵 초기화
      map = new naver.maps.Map('map', {
        center: new naver.maps.LatLng(lat, lng),
        zoom: zoom
      });

      // 2. 장소 이름(place)이 있으면 검색 실행
      if (place) {
        hud('검색 중: ' + place);
        
        // geocoder 서브모듈 로드 확인
        if (!naver.maps.Service || !naver.maps.Service.geocode) {
            hud('오류: Geocoder 모듈이 로드되지 않았습니다.');
            return;
        }

        naver.maps.Service.geocode({ query: place }, function(status, response) {
            if (status === naver.maps.Service.Status.OK && response.v2.addresses.length > 0) {
                // 검색 성공 -> 이동
                const item = response.v2.addresses[0]; 
                const newPoint = new naver.maps.LatLng(item.y, item.x);
                
                map.setCenter(newPoint); // 지도 중심 이동
                new naver.maps.Marker({ position: newPoint, map: map, title: place }); // 마커 표시
                
                hud('이동 완료: ' + place);
                console.log("검색 성공 좌표:", item.y, item.x);
            } else {
                // 검색 실패
                hud('장소를 찾을 수 없습니다: ' + place);
                console.log("검색 실패 response:", response);
            }
        });
      }

      // Unity 통신용 (기존 유지)
      window.UnityMap = {
        setCenter: (la, ln) => {
          map.setCenter(new naver.maps.LatLng(la, ln));
        },
        updateMyLocation: (la, ln) => {
             // 위치 업데이트 로직 (필요 시 구현)
        }
      };
    });

    document.head.appendChild(s);
  })();
  </script>
</head>
<body>
  <div id="map"></div>
</body>
</html>