<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="referrer" content="origin">
  <title>Naver Map (WebView)</title>
  <style>
    html,body,#map{height:100%;margin:0;padding:0}
    .err{position:fixed; inset:0; display:grid; place-items:center;
         font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; text-align:center; padding:24px}
    .hud{position:fixed;left:8px;bottom:8px;background:#0008;color:#fff;padding:6px 10px;border-radius:8px;font:12px/1.3 system-ui}
    .fab{
      position:fixed;
      left:calc(12px + env(safe-area-inset-left));
      top:calc(12px + env(safe-area-inset-top));
      min-width:44px; height:44px; padding:0 14px;
      border:0; border-radius:999px;
      background:#3478F6; color:#fff; font:14px/44px system-ui;
      box-shadow:0 4px 12px rgba(0,0,0,.25); cursor:pointer;
      z-index:2147483647;
      -webkit-user-select:none; user-select:none;
      -webkit-tap-highlight-color:transparent;
      transform:translateZ(0);
    }
    .fab:active{ transform:translateY(1px); }
  </style>
  <script>
  (function(){
    const DEFAULT_CID = "pu0ce4kfq8";

    const qs   = new URLSearchParams(location.search);
    const cid  = (qs.get('cid')  || DEFAULT_CID).trim();
    const lat  = parseFloat(qs.get('lat')  || '37.58361');
    const lng  = parseFloat(qs.get('lng')  || '127.02528');
    const zoom = parseInt (qs.get('zoom') || '17', 10);
    
    // 보민: URL에서 검색할 장소 이름(place)을 가져오는 변수 추가
    const place = (qs.get('place') || '').trim();

    const atarget = (qs.get('atarget') || 'Main').trim();
    const enableSim = qs.get('sim') === '1';

    let map, myMarker, accCircle;

    function ready(fn){
      if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', fn, {once:true});
      else fn();
    }
    function showError(msg){
      ready(()=>{
        const div=document.createElement('div');
        div.className='err';
        div.innerHTML=`<div><b>네이버 지도 로드 실패</b><br>${msg}<br><br>
                       <small>URI: ${location.href}</small></div>`;
        document.body.appendChild(div);
      });
    }
    function hud(msg){
      let h=document.querySelector('.hud');
      if(!h){ h=document.createElement('div'); h.className='hud'; document.body.appendChild(h); }
      h.textContent=msg;
    }

    const isUniWebView =
      qs.get('uv') === '1' ||
      (typeof window !== 'undefined' && window.__uv === 1) ||
      /UniWebView/i.test(navigator.userAgent);

    function goAndroid(target){
      location.href = "uniwebview://goAndroid";
    }

    if(!cid){ showError('cid(클라이언트ID)가 없습니다. 예) ?cid=YOUR_CLIENT_ID'); return; }

    // 보민: 주소 검색 기능을 쓰기 위해 &submodules=geocoder 를 뒤에 추가함
    const s=document.createElement('script');
    s.src='https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId='+encodeURIComponent(cid) + '&submodules=geocoder';

    s.onload=()=>ready(()=>{
      // 1. 기본 지도 생성 (일단 기본 좌표로 만듦)
      const centerLat = isNaN(lat) ? 37.58361 : lat;
      const centerLng = isNaN(lng) ? 127.02528 : lng;

      map=new naver.maps.Map('map',{
        center:new naver.maps.LatLng(centerLat, centerLng),
        zoom:isNaN(zoom)?17:zoom,
        zoomControl:true,
        zoomControlOptions:{position:naver.maps.Position.TOP_RIGHT}
      });

      // 보민: 만약 장소 이름(place)이 있다면 네이버 서버에 위치를 물어보고(geocode), 지도를 그곳으로 이동시킴
      if(place) {
        naver.maps.Service.geocode({ query: place }, function(status, response) {
            if (status === naver.maps.Service.Status.OK && response.v2.addresses.length > 0) {
                var result = response.v2.addresses[0]; // 첫 번째 검색 결과
                var newPoint = new naver.maps.LatLng(result.y, result.x); // y=위도, x=경도
                
                map.setCenter(newPoint); // 지도 중심 이동
                
                // (선택사항) 검색된 위치에 마커 표시
                new naver.maps.Marker({ position: newPoint, map: map, title: place });
                hud('이동 완료: ' + place);
            } else {
                hud('장소를 찾을 수 없습니다: ' + place);
            }
        });
      }

      window.UnityMap = {
        setCenter:(la,ln)=>{
          const p=new naver.maps.LatLng(+la,+ln);
          map.setCenter(p);
          return true;
        },
        setZoom:(z)=>{ map.setZoom(+z); return true; },
        addMarker:(la,ln,title)=>{
          const p=new naver.maps.LatLng(+la,+ln);
          new naver.maps.Marker({ position:p, map, title:title||'' });
          return true;
        },
        updateMyLocation:(la,ln,accMeters=0)=>{
          const p=new naver.maps.LatLng(+la,+ln);
          if(!myMarker){
            myMarker=new naver.maps.Marker({
              position:p, map,
              icon:{
                content:`<div style="width:14px;height:14px;border-radius:50%;
                                 background:#3478F6;border:2px solid #fff;box-shadow:0 0 0 2px #3478F633"></div>`,
                size:new naver.maps.Size(14,14),
                anchor:new naver.maps.Point(7,7)
              }
            });
          }else{
            myMarker.setPosition(p);
          }
          const radius = Math.max(0, +accMeters||0);
          if(radius>0){
            if(!accCircle){
              accCircle=new naver.maps.Circle({
                map, center:p, radius,
                fillColor:'#3478F6', fillOpacity:0.15,
                strokeColor:'#3478F6', strokeOpacity:0.5, strokeWeight:2
              });
            }else{
              accCircle.setCenter(p);
              accCircle.setRadius(radius);
            }
          }else if(accCircle){
            accCircle.setMap(null); accCircle=null;
          }
          return true;
        }
      };

      const btn = document.createElement('button');
      btn.className = 'fab';
      btn.id = 'goAndroidBtn';
      btn.type = 'button';
      btn.textContent = '메인 화면';
      btn.addEventListener('click', ()=> goAndroid());
      document.body.appendChild(btn);

      if(enableSim){
        hud('SIM: running');
      }
    });
    s.onerror=()=>showError('maps.js 로드 실패: cid/도메인 설정을 확인하세요.');
    document.head.appendChild(s);
  })();
  </script>
</head>
<body>
  <div id="map"></div>
  <div class="hud" style="display:none"></div>
</body>
</html>