<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="referrer" content="origin">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Naver Map (Callback Version)</title>
  <style>
    html,body,#map{height:100%;margin:0;padding:0}
    .hud{position:fixed;left:8px;bottom:8px;background:#0008;color:#fff;padding:6px 10px;border-radius:8px;font:12px/1.3 system-ui; z-index: 1000;}
  </style>
  <script>
    // 전역 변수로 선언
    const DEFAULT_CID = "pu0ce4kfq8"; 
    let map;

    // ★ 1. 네이버 지도가 모든 준비를 마친 뒤에 호출할 함수 정의
    window.initMap = function() {
        const qs = new URLSearchParams(location.search);
        
        // URL 파라미터 가져오기
        const place = (qs.get('place') || '').trim();
        let lat = parseFloat(qs.get('lat') || '37.58361');
        let lng = parseFloat(qs.get('lng') || '127.02528');
        const zoom = parseInt(qs.get('zoom') || '17', 10);

        function hud(msg){
            let h=document.querySelector('.hud');
            if(!h){ h=document.createElement('div'); h.className='hud'; document.body.appendChild(h); }
            h.textContent=msg;
        }

        // 맵 생성
        map = new naver.maps.Map('map', {
            center: new naver.maps.LatLng(lat, lng),
            zoom: zoom
        });

        // // ★ 2. 이제 Geocoder가 확실히 로드된 상태에서 검색 실행
        // if (place) {
        //     hud('검색 중: ' + place);
            
        //     if (!naver.maps.Service || !naver.maps.Service.geocode) {
        //         hud('치명적 오류: Geocoder 로드 실패. 새로고침 해주세요.');
        //         return;
        //     }

        //     naver.maps.Service.geocode({ query: place }, function(status, response) {
        //         if (status === naver.maps.Service.Status.OK && response.v2.addresses.length > 0) {
        //             const item = response.v2.addresses[0];
        //             const newPoint = new naver.maps.LatLng(item.y, item.x);
                    
        //             map.setCenter(newPoint);
        //             new naver.maps.Marker({ position: newPoint, map: map, title: place });
                    
        //             hud('이동 완료: ' + place);
        //             console.log("GEOCODE SUCCESS:", item);
        //         } else {
        //             hud('검색 실패 (결과 없음): ' + place);
        //             console.log("GEOCODE FAIL:", response);
        //         }
        //     });
        // }

        // Unity 통신 객체
        window.UnityMap = {
            setCenter: (la, ln) => { map.setCenter(new naver.maps.LatLng(la, ln)); },
            updateMyLocation: (la, ln) => { /* ... */ }
        };
    };

    // ★ 3. 스크립트 로드 (onload 대신 callback 파라미터 사용)
    (function(){
        const qs = new URLSearchParams(location.search);
        const cid = (qs.get('cid') || DEFAULT_CID).trim();
        
        const s = document.createElement('script');
        // 주소 끝에 &callback=initMap 을 추가하여, 로딩 완료 후 initMap 함수가 실행되도록 함
        s.src = 'https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=' + encodeURIComponent(cid) + '&submodules=geocoder&callback=initMap';
        document.head.appendChild(s);
    })();
  </script>
</head>
<body>
  <div id="map"></div>
</body>
</html>