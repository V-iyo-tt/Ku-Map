<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="referrer" content="origin">
  <title>Naver Map (WebView)</title>
  <style>
    html,body,#map{height:100%;margin:0;padding:0}
    .err{position:fixed; inset:0; display:grid; place-items:center;
         font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; text-align:center; padding:24px}
    .hud{position:fixed;left:8px;bottom:8px;background:#0008;color:#fff;padding:6px 10px;border-radius:8px;font:12px/1.3 system-ui}
    /* 1105 ì›¹ë·° ìœ„ ë²„íŠ¼ ë– ë‹¤ë‹ˆëŠ” ì•¡ì…˜ ë²„íŠ¼(FAB) */
    .fab{
  position:fixed;
  left:calc(12px + env(safe-area-inset-left));
  top:calc(12px + env(safe-area-inset-top));
  min-width:44px; height:44px; padding:0 14px;
  border:0; border-radius:999px;
  background:#3478F6; color:#fff; font:14px/44px system-ui;
  box-shadow:0 4px 12px rgba(0,0,0,.25); cursor:pointer;
  z-index:2147483647;
  -webkit-user-select:none; user-select:none;
  -webkit-tap-highlight-color:transparent;
  transform:translateZ(0);
}
.fab:active{ transform:translateY(1px); }
  </style>
  <script>
  (function(){
    const DEFAULT_CID = "i05xoo0sn8";

    const qs   = new URLSearchParams(location.search);
    const cid  = (qs.get('cid')  || DEFAULT_CID).trim();
    const lat  = parseFloat(qs.get('lat')  || '37.58361');
    const lng  = parseFloat(qs.get('lng')  || '127.02528');
    const zoom = parseInt (qs.get('zoom') || '17', 10);

    // 1105 ë²„íŠ¼ì´ ë„˜ê¸¸ ê¸°ë³¸ íƒ€ê²Ÿ (ì¿¼ë¦¬ë¡œ ë®ì–´ì“°ê¸° ê°€ëŠ¥) ì˜ˆ: ?atarget=Main
    const atarget = (qs.get('atarget') || 'Main').trim();

    // ì—ë””í„°/ë¸Œë¼ìš°ì € ë‹¨ë… í™•ì¸ìš©: ?sim=1 ì´ë©´ ìë™ ê²½ë¡œ ì‹œë®¬ë ˆì´í„° ì¼œì§
    const enableSim = qs.get('sim') === '1';

    let map, myMarker, accCircle;

    function ready(fn){
      if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', fn, {once:true});
      else fn();
    }
    function showError(msg){
      ready(()=>{
        const div=document.createElement('div');
        div.className='err';
        div.innerHTML=`<div><b>ë„¤ì´ë²„ ì§€ë„ ë¡œë“œ ì‹¤íŒ¨</b><br>${msg}<br><br>
                       <small>URI: ${location.href}</small></div>`;
        document.body.appendChild(div);
      });
    }
    function hud(msg){
      let h=document.querySelector('.hud');
      if(!h){ h=document.createElement('div'); h.className='hud'; document.body.appendChild(h); }
      h.textContent=msg;
    }

    // 1105 UniWebView ê°ì§€
    // const isUniWebView = /UniWebView/i.test(navigator.userAgent);
    // ì•± ê°ì§€: ì¿¼ë¦¬ í”Œë˜ê·¸(uv), JS í”Œë˜ê·¸(__uv), UA(ì˜ˆë¹„)
    const isUniWebView =
  qs.get('uv') === '1' ||            // Unityê°€ URLì— ë¶™ì—¬ì¤Œ
  (typeof window !== 'undefined' && window.__uv === 1) ||
  /UniWebView/i.test(navigator.userAgent);

    // 1105 ìœ ë‹ˆí‹°(â†’ì•ˆë“œë¡œì´ë“œ)ë¡œ ì‹ í˜¸ ë³´ë‚´ëŠ” í•¨ìˆ˜
    function goAndroid(target){
  //     // const t = encodeURIComponent((target || atarget || 'Main').trim());
  //     // const url = `uniwebview://goAndroid?target=${t}`;
  //     // if(isUniWebView){
  //     //   // UniWebViewê°€ ì´ ìŠ¤í‚´ì„ ê°€ë¡œì±„ì„œ Unity C# OnMessageReceivedë¡œ ì „ë‹¬
  //     //   location.href = url;
  //     //   hud('ì•ˆë“œë¡œì´ë“œ í™”ë©´ ì „í™˜ ìš”ì²­ ì „ì†¡ë¨');
  //     // }else{
  //     //   // ë¸Œë¼ìš°ì €ì—ì„œ ì—´ì—ˆì„ ë•Œì˜ ì•ˆë‚´
  //     //   alert('ì´ ë²„íŠ¼ì€ ì•± ë‚´ ì›¹ë·°ì—ì„œ ë™ì‘í•©ë‹ˆë‹¤. (UniWebView ìŠ¤í‚´)');
  //     // }
  //     const t = encodeURIComponent((target || atarget || 'Main').trim());
  // const url = `uniwebview://goAndroid?target=${t}`;

  // // í•­ìƒ ì‹œë„. ì•±ì´ë©´ UniWebViewê°€ ê°€ë¡œì±„ê³ , ë¸Œë¼ìš°ì €ë©´ ì¡°ìš©íˆ ë¬´ì‹œ(ë˜ëŠ” OS ì—ëŸ¬ í˜ì´ì§€).
  // location.href = url;
      location.href = "uniwebview://goAndroid"; // â† íŒŒë¼ë¯¸í„° ì—†ìŒ
    }

    if(!cid){ showError('cid(í´ë¼ì´ì–¸íŠ¸ID)ê°€ ì—†ìŠµë‹ˆë‹¤. ì˜ˆ) ?cid=YOUR_CLIENT_ID'); return; }

    // ğŸ‘‰ ì›ë˜ ì“°ë˜ ë¡œë” ê·¸ëŒ€ë¡œ ìœ ì§€ (ncpKeyId)
    const s=document.createElement('script');
    s.src='https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId='+encodeURIComponent(cid);
    // í•„ìš”ì‹œ, ë‹¹ì‹  í™˜ê²½ì—ì„œ ncpClientIdë¡œ ì¨ì•¼ í•œë‹¤ë©´ ìœ„ ì¤„ ëŒ€ì‹  ì•„ë˜ ì£¼ì„ í•´ì œ
    // s.src = 'https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=' + encodeURIComponent(cid);

    s.onload=()=>ready(()=>{
      map=new naver.maps.Map('map',{
        center:new naver.maps.LatLng(lat,lng),
        zoom:isNaN(zoom)?17:zoom,
        zoomControl:true,
        zoomControlOptions:{position:naver.maps.Position.TOP_RIGHT}
      });

      // ===== Unityì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” API =====
      window.UnityMap = {
        setCenter:(la,ln)=>{
          const p=new naver.maps.LatLng(+la,+ln);
          map.setCenter(p);
          return true;
        },
        setZoom:(z)=>{ map.setZoom(+z); return true; },
        addMarker:(la,ln,title)=>{
          const p=new naver.maps.LatLng(+la,+ln);
          new naver.maps.Marker({ position:p, map, title:title||'' });
          return true;
        },
        /** â–¶ ì‹¤ì‹œê°„ ìœ„ì¹˜ ê°±ì‹ (ë§ˆì»¤ ê³ ì • ì¬ì‚¬ìš© + ì •í™•ë„ ì›) */
        updateMyLocation:(la,ln,accMeters=0)=>{
          const p=new naver.maps.LatLng(+la,+ln);

          // ìµœì´ˆ ìƒì„±
          if(!myMarker){
            myMarker=new naver.maps.Marker({
              position:p, map,
              icon:{
                content:`<div style="width:14px;height:14px;border-radius:50%;
                                 background:#3478F6;border:2px solid #fff;box-shadow:0 0 0 2px #3478F633"></div>`,
                size:new naver.maps.Size(14,14),
                anchor:new naver.maps.Point(7,7)
              }
            });
          }else{
            myMarker.setPosition(p);
          }

          // ì •í™•ë„ ì›
          const radius = Math.max(0, +accMeters||0);
          if(radius>0){
            if(!accCircle){
              accCircle=new naver.maps.Circle({
                map, center:p, radius,
                fillColor:'#3478F6', fillOpacity:0.15,
                strokeColor:'#3478F6', strokeOpacity:0.5, strokeWeight:2
              });
            }else{
              accCircle.setCenter(p);
              accCircle.setRadius(radius);
            }
          }else if(accCircle){
            accCircle.setMap(null); accCircle=null;
          }

          return true;
        }
      };

      // ===== 1105 í™”ë©´ ì „í™˜ ë²„íŠ¼ ìƒì„± =====
      const btn = document.createElement('button');
      btn.className = 'fab';
      btn.id = 'goAndroidBtn';
      btn.type = 'button';
      btn.textContent = 'ë©”ì¸ í™”ë©´';
      btn.addEventListener('click', ()=> goAndroid());
      document.body.appendChild(btn);

      // ===== ë¸Œë¼ìš°ì €/ì—ë””í„° ë‹¨ë… í™•ì¸ìš© ìë™ ì‹œë®¬ë ˆì´í„° =====
      if(enableSim){
        const route = [
          [37.58361,127.02528,5],  // ì‹œì‘
          [37.58320,127.02650,5],
          [37.58270,127.02780,6],  // ê³µí•™ê´€ ê·¼ì²˜
          [37.58210,127.02890,6],  // ì°½ì˜ê´€ ê·¼ì²˜
          [37.58150,127.03020,7]   // ì‹ ê³µí•™ê´€ ê·¼ì²˜
        ];
        let i=0;
        hud('SIM: running');
        function tick(){
          const [la,ln,acc]=route[i];
          UnityMap.updateMyLocation(la,ln,acc);
          UnityMap.setCenter(la,ln);
          i=(i+1)%route.length;
          setTimeout(tick, 1200);
        }
        tick();
      }
    });
    s.onerror=()=>showError('maps.js ë¡œë“œ ì‹¤íŒ¨: cid/ë„ë©”ì¸ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.');
    document.head.appendChild(s);
  })();
  </script>
</head>
<body>
  <div id="map"></div>
  <!-- 1105 ë¸Œë¼ìš°ì € ë””ë²„ê·¸ìš© HUD(í•„ìš” ì‹œ í‘œì‹œë¨) -->
  <div class="hud" style="display:none"></div>
</body>
</html>
